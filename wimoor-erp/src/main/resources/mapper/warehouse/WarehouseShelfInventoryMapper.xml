<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wimoor.erp.warehouse.mapper.WarehouseShelfInventoryMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.wimoor.erp.warehouse.pojo.entity.WarehouseShelfInventory">
        <id column="id" property="id" />
        <result column="shelfid" property="shelfid" />
        <result column="materialid" property="materialid" />
        <result column="shopid" property="shopid" />
        <result column="quantity" property="quantity" />
        <result column="size" property="size" />
        <result column="operator" property="operator" />
        <result column="opttime" property="opttime" />
    </resultMap>
 
	<select id="sumByShelf"   resultType="com.wimoor.erp.warehouse.pojo.vo.WarehouseShelfInventorySummaryVo"  parameterType="com.wimoor.erp.warehouse.pojo.entity.WarehouseShelf">
	    select * from (
		     SELECT sum(case when quantity >0 then 1 else 0 end) skunum,sum(quantity) quantity,sum(size)  size ,
		     max(e.name) warehousename,
		     max(u.name) operator,
		     max(s.opttime) opttime,
		     max(u2.name) creator,
		     max(s.creattime) creattime
		     FROM  t_erp_warehouse_shelf s 
		     left join t_erp_warehouse e on e.id=s.warehouseid
			 left join  t_erp_warehouse_shelf_inventory i on s.id=i.shelfid and s.shopid=i.shopid
			 left join t_userinfo u on u.id=s.operator
			 left join t_userinfo u2 on u2.id=s.creator
			 where s.shopid=#{shopid,jdbcType=CHAR}  
			   and s.warehouseid=#{warehouseid,jdbcType=CHAR}
			   <if test="treepath!=null">
	   			   and s.treepath like CONCAT(#{treepath,jdbcType=CHAR},'%') 
			   </if>
			   and s.isdelete=0
	     ) v1
	    cross join (
	        select count(subv.materialid) expnumber FROM   
	         (SELECT   i.materialid,SUM(i.quantity) quantity 
		        FROM  t_erp_warehouse_shelf s 
			     left join  t_erp_warehouse_shelf_inventory i on s.id=i.shelfid and s.shopid=i.shopid
			     where s.shopid=#{shopid,jdbcType=CHAR}  
				   and s.warehouseid=#{warehouseid,jdbcType=CHAR}
				   <if test="treepath!=null">
	                   and s.treepath like CONCAT(#{treepath,jdbcType=CHAR},'%') 
	               </if>
			      and s.isdelete=0
			  group by i.materialid) subv  
			  left join t_erp_inventory i on i.warehouseid=#{warehouseid,jdbcType=CHAR} and i.shopid=#{shopid,jdbcType=CHAR}    and i.materialid=subv.materialid and i.status='fulfillable'
			  where subv.quantity>i.quantity 
	     ) v2  
	     
	      
	</select>

    <select id="findByMaterial"   resultType="com.wimoor.api.erp.warehouse.pojo.vo.WarehouseShelfInventoryVo"  parameterType="java.lang.String">
			   SELECT   i.id,i.shelfid,i.materialid,s.`name` shelfname,i.quantity,i.size,
			            m.sku,m.name,p.location image,
				        s.treepath
			     FROM t_erp_warehouse_shelf_inventory i 
			     left join t_erp_material m on m.id=i.materialid
			     left join t_picture p on p.id=m.image
				 left join t_erp_warehouse_shelf s on s.id=i.shelfid and s.shopid=i.shopid
				 where s.shopid=#{shopid,jdbcType=CHAR}  
				   and s.warehouseid=#{warehouseid,jdbcType=CHAR}
				   and i.materialid=#{materialid,jdbcType=CHAR}
				   and s.isdelete=0
				   order by i.opttime asc
	   </select>

	   <select id="getShelfList"   resultType="com.wimoor.api.erp.warehouse.pojo.vo.WarehouseShelfInventoryVo"  >
	     SELECT  
	      p.location image,
          m.sku,
		  m.name,
		  ifnull(v1.quantity,0) warehousequantity,
		  m.id id,
		  ifnull(v2.quantity,0) shelfquantity,
		  ifnull(v1.quantity,0)-  ifnull(v2.quantity,0) quantity,
		  ifnull(v1.quantity,0)-  ifnull(v2.quantity,0) amount,
		  m.id materialid ,
		  v1.opttime,
		  v2.shelfid,
 		  <if test="param.shelfid!=null">
		  case when v2.shelfid=#{param.shelfid,jdbcType=CHAR} then now() else v1.opttime end orderitem
		  </if> 
		  <if test="param.shelfid==null">
		  v1.opttime orderitem
		</if>
		from  (select materialid,sum(quantity) quantity,max(opttime)  opttime
					  from t_erp_inventory  
				      where shopid=#{param.shopid,jdbcType=CHAR} and warehouseid=#{param.warehouseid,jdbcType=CHAR} and status ='fulfillable'
					  group by materialid
		 ) v1  
		left join (
						select i.materialid,ifnull(sum(i.quantity),0) quantity,s.id shelfid
						from t_erp_warehouse_shelf_inventory  i
						left join t_erp_warehouse_shelf s on s.id=i.shelfid
						where i.shopid=#{param.shopid,jdbcType=CHAR} and s.warehouseid=#{param.warehouseid,jdbcType=CHAR}
						group by i.materialid
		) v2 on v2.materialid=v1.materialid
		left join t_erp_material m  on m.id=v1.materialid
		left join t_picture p on p.id=m.image
		where m.shopid=#{param.shopid,jdbcType=CHAR}  
			  and v1.quantity  &gt; ifnull(v2.quantity,0)
		 <if test="param.search!=null">
		   and m.sku like #{param.search,jdbcType=CHAR}
		</if> 
	 
	</select>
		
	<select id="getShelfInventoryList"   resultType="com.wimoor.api.erp.warehouse.pojo.vo.WarehouseShelfInventoryVo" >
		SELECT m.name,m.sku,p.location image,t.quantity amount,w.name warehousename,s.treepath,s.warehouseid,t.*
		FROM t_erp_warehouse_shelf_inventory t
		left join t_erp_warehouse_shelf s on s.id=t.shelfid
		left join t_erp_warehouse w on w.id=s.warehouseid
		LEFT JOIN t_erp_material m ON m.id=t.materialid
		LEFT JOIN t_picture p ON p.id=m.image
		WHERE t.shopid=#{param.shopid,jdbcType=CHAR}
		<if test="param.shelfid!=null">
		    and t.shelfid=#{param.shelfid,jdbcType=CHAR}
		</if>
		   and s.warehouseid=#{param.warehouseid,jdbcType=CHAR}
		<if test="param.treepath!=null">
		    and s.treepath like CONCAT(#{param.treepath,jdbcType=CHAR},'%') 
		</if>
		   and t.quantity>0
		<if test="param.search!=null">
			and m.sku like #{param.search,jdbcType=CHAR}
		</if>
		and s.isdelete=0
	</select>  
	 
 
</mapper>
